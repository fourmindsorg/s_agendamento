name: Deploy to AWS

# Desabilitado: Configure AWS secrets e SSH key primeiro
# Para habilitar, descomente as linhas abaixo
on:
  # push:
  #   branches:
  #     - main
  workflow_dispatch:  # Apenas execuÃ§Ã£o manual

env:
  AWS_REGION: us-east-1
  EC2_HOST: 34.228.191.215
  PROJECT_NAME: sistema-agendamento-4minds
  DOMAIN: fourmindstech.com.br

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_HOST }} << 'EOF'
            set -e
            
            echo "=== Atualizando cÃ³digo do repositÃ³rio ==="
            cd /home/django/sistema-de-agendamento
            
            # Fazer backup do .env
            cp .env .env.backup
            
            # Atualizar cÃ³digo
            sudo -u django git fetch origin
            sudo -u django git reset --hard origin/main
            
            # Restaurar .env
            cp .env.backup .env
            
            # Ativar ambiente virtual
            source venv/bin/activate
            
            # Instalar/atualizar dependÃªncias
            pip install -r requirements.txt
            
            # Executar migraÃ§Ãµes
            export DB_NAME=agendamentos_db
            export DB_USER=postgres
            export DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            export DB_HOST=${{ secrets.DB_HOST }}
            export DB_PORT=5432
            
            python manage.py migrate --settings=core.settings_production
            
            # Coletar arquivos estÃ¡ticos
            python manage.py collectstatic --noinput --settings=core.settings_production
            
            # Corrigir permissÃµes
            sudo chown -R django:django staticfiles/
            sudo chmod -R 755 staticfiles/
            
            # Reiniciar serviÃ§os
            sudo systemctl restart django
            sudo systemctl reload nginx
            
            echo "=== Deploy concluÃ­do com sucesso! ==="
          EOF

      - name: Verificar status dos serviÃ§os
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ env.EC2_HOST }} << 'EOF'
            echo "=== Status Django ==="
            sudo systemctl status django --no-pager | head -10
            
            echo ""
            echo "=== Status Nginx ==="
            sudo systemctl status nginx --no-pager | head -10
            
            echo ""
            echo "=== Teste HTTP ==="
            curl -I http://localhost:8000 | head -5
          EOF

      - name: Notificar sucesso
        if: success()
        run: |
          echo "âœ… Deploy realizado com sucesso!"
          echo "ðŸŒ Site: https://${{ env.DOMAIN }}"
          echo "ðŸ” Admin: https://${{ env.DOMAIN }}/admin"

      - name: Notificar falha
        if: failure()
        run: |
          echo "âŒ Deploy falhou! Verifique os logs acima."




