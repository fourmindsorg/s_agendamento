{% extends 'base.html' %}

{% block title %}Relatórios - Sistema de Agendamentos{% endblock %}

{% block extra_css %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
  /* Header personalizado */
  .reports-header {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
    position: relative;
  }
  
  .reports-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-color) !important;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 15px;
  }
  
  .reports-subtitle {
    color: var(--text-muted-color) !important;
    margin: 8px 0 0 0;
    font-size: 1rem;
  }
  
  /* Ações no Header */
  .header-actions {
    position: absolute;
    top: 0;
    right: 0;
    display: flex;
    gap: 10px;
    align-items: flex-start;
  }
  
  @media (max-width: 768px) {
    .header-actions {
      position: relative;
      top: auto;
      right: auto;
      margin-top: 15px;
      justify-content: flex-start;
      flex-wrap: wrap;
    }
    
    .reports-title {
      font-size: 1.5rem;
    }
  }

  /* KPI Cards */
  .kpi-card {
    background: var(--gradient-bg);
    color: white !important;
    border-radius: 15px;
    border: none;
    transition: all 0.3s ease;
    overflow: hidden;
    position: relative;
  }

  .kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
    pointer-events: none;
  }
  
  .kpi-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 15px 35px rgba(0,0,0,0.2);
  }

  .kpi-card * {
    color: white !important;
  }
  
  .kpi-value {
    font-size: 2.2rem;
    font-weight: 700;
    margin: 10px 0;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }
  
  .kpi-label {
    font-size: 0.9rem;
    opacity: 0.9;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .kpi-change {
    font-size: 0.8rem;
    padding: 4px 12px;
    border-radius: 15px;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
    font-weight: 600;
  }

  .kpi-icon {
    font-size: 2.5rem;
    opacity: 0.8;
    margin-bottom: 15px;
  }
  
  /* Chart Containers */
  .chart-container {
    background: var(--surface-color);
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
  }

  .chart-container:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  }

  .chart-container h5 {
    color: var(--text-color) !important;
    font-weight: 600;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--border-color);
  }
  
  /* Filter Card */
  .filter-card {
    background: var(--light-color);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid var(--border-color);
  }

  /* Buttons */
  .btn-custom {
    background: var(--gradient-bg);
    border: none;
    color: white !important;
    font-weight: 600;
    padding: 10px 20px;
    border-radius: 8px;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .btn-custom:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px var(--shadow-color);
    color: white !important;
  }

  /* Chart Toggle Buttons */
  .chart-toggle {
    background: var(--surface-color);
    border: 2px solid var(--border-color);
    color: var(--text-color) !important;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .chart-toggle:hover {
    border-color: var(--primary-color);
    background: var(--light-color);
  }

  .chart-toggle.active {
    background: var(--primary-color) !important;
    border-color: var(--primary-color) !important;
    color: white !important;
  }

  /* Table Styling */
  .table {
    color: var(--text-color) !important;
    background: transparent;
  }

  .table th {
    background: var(--light-color) !important;
    color: var(--text-color) !important;
    border-color: var(--border-color) !important;
    font-weight: 600;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .table td {
    color: var(--text-color) !important;
    border-color: var(--border-color) !important;
    vertical-align: middle;
  }

  .table-striped tbody tr:nth-of-type(odd) {
    background-color: var(--light-color) !important;
  }

  /* Insights Card */
  .insights-card {
    border-radius: 15px;
    border: none;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    overflow: hidden;
  }

  .insights-card .card-header {
    background: var(--dark-color) !important;
    color: white !important;
    padding: 20px 25px;
    border: none;
  }

  .insights-card .card-body {
    padding: 25px;
    background: var(--surface-color);
  }

  .insight-item {
    padding: 12px 0;
    border-bottom: 1px solid var(--border-color);
    transition: all 0.3s ease;
  }

  .insight-item:last-child {
    border-bottom: none;
  }

  .insight-item:hover {
    background: var(--light-color);
    margin: 0 -15px;
    padding: 12px 15px;
    border-radius: 8px;
  }

  .insight-icon {
    width: 20px;
    text-align: center;
  }

  /* Modal Styling */
  .modal-content {
    border-radius: 15px;
    border: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  }

  .modal-header {
    border-bottom: 1px solid var(--border-color);
    background: var(--surface-color);
    border-radius: 15px 15px 0 0;
  }

  .modal-body {
    background: var(--surface-color);
    padding: 25px;
  }

  .modal-footer {
    border-top: 1px solid var(--border-color);
    background: var(--surface-color);
    border-radius: 0 0 15px 15px;
  }

  /* Form Controls */
  .form-control {
    border-radius: 8px !important;
    border: 2px solid var(--border-color) !important;
    background: var(--surface-color) !important;
    color: var(--text-color) !important;
    padding: 10px 12px;
  }

  .form-control:focus {
    border-color: var(--primary-color) !important;
    box-shadow: 0 0 0 0.2rem var(--shadow-color) !important;
    background: var(--surface-color) !important;
    color: var(--text-color) !important;
  }

  .form-label {
    color: var(--text-color) !important;
    font-weight: 600;
    margin-bottom: 5px;
  }

  /* Quick Period Buttons */
  .period-btn {
    background: var(--surface-color);
    border: 2px solid var(--border-color);
    color: var(--text-color) !important;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
    flex: 1;
  }

  .period-btn:hover {
    border-color: var(--primary-color);
    background: var(--primary-color);
    color: white !important;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .kpi-value {
      font-size: 1.8rem;
    }

    .chart-container {
      padding: 20px;
    }

    .kpi-icon {
      font-size: 2rem;
    }

    .header-actions {
      width: 100%;
      justify-content: center;
    }
  }

  /* Animations */
  .chart-container, .kpi-card, .insights-card {
    animation: slideInUp 0.5s ease-out;
  }

  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Growth indicators */
  .growth-positive {
    color: var(--success-color) !important;
  }

  .growth-negative {
    color: var(--danger-color) !important;
  }

  .growth-neutral {
    color: var(--text-muted-color) !important;
  }

  /* Period indicator */
  .period-indicator {
    background: rgba(255,255,255,0.2);
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-left: 10px;
  }
</style>
{% endblock %}

{% block content %}
<!-- Header dos Relatórios -->
<div class="reports-header">
  <h1 class="reports-title">
    <i class="fas fa-chart-bar"></i>
    Relatórios e Analytics
  </h1>
  <p class="reports-subtitle">
    Insights detalhados do seu negócio
    <span class="period-indicator">
      <i class="fas fa-calendar me-1"></i>
      {{ data_inicio|date:"d/m/Y" }} até {{ data_fim|date:"d/m/Y" }}
    </span>
  </p>
  
  <!-- Ações no Header -->
  <div class="header-actions">
    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#filtroModal">
      <i class="fas fa-filter"></i>Filtros
    </button>
    <a href="{% url 'agendamentos:dashboard' %}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left"></i>Dashboard
    </a>
  </div>
</div>

<!-- KPIs Financeiros -->
<div class="row g-2 mb-2">
  <div class="col-md-3">
    <div class="card kpi-card h-100">
      <div class="card-body text-center">
        <i class="fas fa-dollar-sign kpi-icon"></i>
        <h3 class="kpi-value">R$ {{ kpis_financeiros.faturamento_total|floatformat:2 }}</h3>
        <p class="kpi-label mb-2">Faturamento Total</p>
        <small class="kpi-change">
          <i class="fas fa-calendar me-1"></i>{{ kpis_financeiros.dias_periodo }} dias
        </small>
      </div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="card kpi-card h-100">
      <div class="card-body text-center">
        <i class="fas fa-receipt kpi-icon"></i>
        <h3 class="kpi-value">R$ {{ kpis_financeiros.ticket_medio|floatformat:2 }}</h3>
        <p class="kpi-label mb-2">Ticket Médio</p>
        <small class="kpi-change">
          <i class="fas fa-chart-line me-1"></i>Por atendimento
        </small>
      </div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="card kpi-card h-100">
      <div class="card-body text-center">
        <i class="fas fa-check-circle kpi-icon"></i>
        <h3 class="kpi-value">{{ kpis_financeiros.total_agendamentos }}</h3>
        <p class="kpi-label mb-2">Atendimentos</p>
        <small class="kpi-change">
          <i class="fas fa-calendar-check me-1"></i>Concluídos
        </small>
      </div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="card kpi-card h-100">
      <div class="card-body text-center">
        <i class="fas fa-trending-up kpi-icon"></i>
        <h3 class="kpi-value">
          {% if kpis_financeiros.crescimento_mensal >= 0 %}
            +{{ kpis_financeiros.crescimento_mensal }}%
          {% else %}
            {{ kpis_financeiros.crescimento_mensal }}%
          {% endif %}
        </h3>
        <p class="kpi-label mb-2">Crescimento</p>
        <small class="kpi-change">
          <i class="fas fa-calendar-alt me-1"></i>Mensal
        </small>
      </div>
    </div>
  </div>
</div>

<!-- Gráficos Principais -->
<div class="row">
  <!-- Faturamento por Dia -->
  <div class="col-lg-8 mb-4">
    <div class="chart-container">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">
          <i class="fas fa-chart-line text-success me-2"></i>
          Faturamento Diário
        </h5>
        <div class="btn-group btn-group-sm">
          <button class="chart-toggle active" onclick="toggleFaturamentoView('daily')">
            Diário
          </button>
          <button class="chart-toggle" onclick="toggleFaturamentoView('cumulative')">
            Acumulado
          </button>
        </div>
      </div>
      <div id="grafico-faturamento" style="height: 400px;"></div>
    </div>
  </div>

  <!-- Serviços Mais Realizados -->
  <div class="col-lg-4 mb-4">
    <div class="chart-container">
      <h5 class="mb-3">
        <i class="fas fa-chart-pie text-warning me-2"></i>
        Serviços Mais Realizados
      </h5>
      <div id="grafico-servicos" style="height: 400px;"></div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Clientes Mais Frequentes -->
  <div class="col-lg-6 mb-4">
    <div class="chart-container">
      <h5 class="mb-3">
        <i class="fas fa-users text-info me-2"></i>
        Top 10 Clientes Mais Frequentes
      </h5>
      <div id="grafico-clientes" style="height: 400px;"></div>
    </div>
  </div>

  <!-- Faturamento Mensal -->
  <div class="col-lg-6 mb-4">
    <div class="chart-container">
      <h5 class="mb-3">
        <i class="fas fa-calendar-alt text-primary me-2"></i>
        Faturamento por Mês
      </h5>
      <div id="grafico-mensal" style="height: 400px;"></div>
      
      <!-- Tabela de Resumo Mensal -->
      <div class="mt-4">
        <h6>
          <i class="fas fa-table me-2"></i>Resumo por Mês:
        </h6>
        <div class="table-responsive">
          <table class="table table-sm table-striped">
            <thead>
              <tr>
                <th>Mês</th>
                <th>Faturamento</th>
                <th>Crescimento</th>
              </tr>
            </thead>
            <tbody>
              {% for item in kpis_financeiros.faturamento_mensal %}
              <tr>
                <td><strong>{{ item.mes }}</strong></td>
                <td>R$ {{ item.valor|floatformat:2 }}</td>
                <td>
                  {% if forloop.counter > 1 %}
                    {% with anterior=kpis_financeiros.faturamento_mensal|slice:":1"|last %}
                      {% if anterior.valor > 0 %}
                        {% widthratio item.valor anterior.valor 100 as crescimento %}
                        {% if crescimento >= 100 %}
                          <span class="growth-positive">
                            <i class="fas fa-arrow-up"></i> +{{ crescimento|add:"-100" }}%
                          </span>
                        {% else %}
                          <span class="growth-negative">
                            <i class="fas fa-arrow-down"></i> -{{ 100|add:crescimento|add:"-100" }}%
                          </span>
                        {% endif %}
                      {% else %}
                        <span class="growth-neutral">-</span>
                      {% endif %}
                    {% endwith %}
                  {% else %}
                    <span class="growth-neutral">-</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Insights e Recomendações -->
<div class="row">
  <div class="col-12">
    <div class="card insights-card">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-lightbulb me-2"></i>Insights e Recomendações
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <h6>
              <i class="fas fa-star text-warning me-2"></i>Pontos Fortes
            </h6>
            <div class="insights-list">
              {% if kpis_financeiros.crescimento_mensal > 0 %}
              <div class="insight-item">
                <i class="fas fa-check-circle text-success insight-icon me-2"></i>
                Crescimento mensal positivo de {{ kpis_financeiros.crescimento_mensal }}%
              </div>
              {% endif %}
              {% if kpis_financeiros.ticket_medio > 50 %}
              <div class="insight-item">
                <i class="fas fa-check-circle text-success insight-icon me-2"></i>
                Ticket médio acima da média (R$ {{ kpis_financeiros.ticket_medio|floatformat:2 }})
              </div>
              {% endif %}
              <div class="insight-item">
                <i class="fas fa-check-circle text-success insight-icon me-2"></i>
                {{ kpis_financeiros.total_agendamentos }} atendimentos realizados no período
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <h6>
              <i class="fas fa-target text-info me-2"></i>Oportunidades
            </h6>
            <div class="insights-list">
              {% if kpis_financeiros.crescimento_mensal < 0 %}
              <div class="insight-item">
                <i class="fas fa-exclamation-triangle text-warning insight-icon me-2"></i>
                Foco na retenção de clientes para reverter queda
              </div>
              {% endif %}
              {% if kpis_financeiros.ticket_medio < 50 %}
              <div class="insight-item">
                <i class="fas fa-arrow-up text-primary insight-icon me-2"></i>
                Oportunidade de aumentar ticket médio com serviços premium
              </div>
              {% endif %}
              <div class="insight-item">
                <i class="fas fa-users text-info insight-icon me-2"></i>
                Implementar programa de fidelidade para clientes frequentes
              </div>
              <div class="insight-item">
                <i class="fas fa-calendar-plus text-success insight-icon me-2"></i>
                Promover serviços menos utilizados para diversificar receita
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Filtros -->
<div class="modal fade" id="filtroModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-filter me-2"></i>Filtrar Relatórios
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="get">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="data_inicio" class="form-label">Data Início</label>
              <input type="date" class="form-control" id="data_inicio" name="data_inicio" 
                     value="{{ data_inicio|date:'Y-m-d' }}">
            </div>
            <div class="col-md-6 mb-3">
              <label for="data_fim" class="form-label">Data Fim</label>
              <input type="date" class="form-control" id="data_fim" name="data_fim" 
                     value="{{ data_fim|date:'Y-m-d' }}">
            </div>
          </div>
          
          <div class="row">
            <div class="col-12">
              <h6 class="mb-3">
                <i class="fas fa-clock me-2"></i>Períodos Rápidos:
              </h6>
              <div class="d-grid gap-2 d-md-flex">
                <button type="button" class="period-btn" onclick="setPeriodo(7)">
                  7 dias
                </button>
                <button type="button" class="period-btn" onclick="setPeriodo(30)">
                  30 dias
                </button>
                <button type="button" class="period-btn" onclick="setPeriodo(90)">
                  90 dias
                </button>
                <button type="button" class="period-btn" onclick="setPeriodo(365)">
                  1 ano
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>Cancelar
          </button>
          <button type="submit" class="btn btn-custom">
            <i class="fas fa-search me-2"></i>Aplicar Filtros
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Dados dos gráficos
    const servicosDados = {{ servicos_dados|safe }};
    const clientesCategorias = {{ clientes_dados.categorias|safe }};
    const clientesValores = {{ clientes_dados.valores|safe }};
    const faturamentoCategorias = {{ faturamento_dados.categorias|safe }};
    const faturamentoValores = {{ faturamento_dados.valores|safe }};
    const faturamentoMensal = {{ kpis_financeiros.faturamento_mensal|safe }};

    // Configurações globais para os gráficos
    const defaultConfig = {
        responsive: true, 
        displayModeBar: false,
        toImageButtonOptions: {
            format: 'png',
            filename: 'grafico',
            height: 500,
            width: 700,
            scale: 1
        }
    };

    // Gráfico de Serviços (Pizza)
    const traceServicos = {
        labels: servicosDados.map(item => item.name),
        values: servicosDados.map(item => item.data),
        type: 'pie',
        hole: 0.4,
        marker: {
            colors: ['var(--primary-color)', 'var(--secondary-color)', 'var(--success-color)', 'var(--warning-color)', 'var(--info-color)', 'var(--danger-color)'],
            line: {
                color: 'var(--surface-color)',
                width: 2
            }
        },
        textinfo: 'label+percent',
        textposition: 'outside',
        textfont: {
            family: 'Inter, sans-serif',
            size: 12,
            color: 'var(--text-color)'
        }
    };

    const layoutServicos = {
        showlegend: false,
        margin: { t: 20, b: 20, l: 20, r: 20 },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { 
            family: 'Inter, sans-serif', 
            size: 12,
            color: 'var(--text-color)'
        }
    };

    Plotly.newPlot('grafico-servicos', [traceServicos], layoutServicos, defaultConfig);

    // Gráfico de Clientes (Barras Horizontais)
    const traceClientes = {
        x: clientesValores,
        y: clientesCategorias,
        type: 'bar',
        orientation: 'h',
        marker: {
            color: 'var(--primary-color)',
            opacity: 0.8,
            line: {
                color: 'var(--primary-color)',
                width: 1
            }
        }
    };

    const layoutClientes = {
        margin: { t: 20, b: 50, l: 150, r: 50 },
        xaxis: { 
            title: 'Número de Atendimentos',
            color: 'var(--text-color)'
        },
        yaxis: { 
            title: '',
            color: 'var(--text-color)'
        },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { 
            family: 'Inter, sans-serif',
            color: 'var(--text-color)'
        }
    };

    Plotly.newPlot('grafico-clientes', [traceClientes], layoutClientes, defaultConfig);

    // Gráfico de Faturamento Diário
    let faturamentoDaily = {
        x: faturamentoCategorias,
        y: faturamentoValores,
        type: 'scatter',
        mode: 'lines+markers',
        line: {
            color: 'var(--success-color)',
            width: 3
        },
        marker: {
            color: 'var(--success-color)',
            size: 6
        },
        fill: 'tonexty',
        fillcolor: 'rgba(40, 167, 69, 0.1)',
        name: 'Faturamento Diário'
    };

    // Calcular faturamento acumulado
    let acumulado = [];
    let soma = 0;
    faturamentoValores.forEach(valor => {
        soma += valor;
        acumulado.push(soma);
    });

    let faturamentoCumulative = {
        x: faturamentoCategorias,
        y: acumulado,
        type: 'scatter',
        mode: 'lines+markers',
        line: {
            color: 'var(--primary-color)',
            width: 3
        },
        marker: {
            color: 'var(--primary-color)',
            size: 6
        },
        fill: 'tonexty',
        fillcolor: 'rgba(0, 123, 255, 0.1)',
        name: 'Faturamento Acumulado',
        visible: false
    };

    const layoutFaturamento = {
        title: {
            text: 'Faturamento Diário',
            font: { 
                size: 16,
                color: 'var(--text-color)'
            }
        },
        xaxis: {
            title: 'Data',
            tickangle: -45,
            color: 'var(--text-color)'
        },
        yaxis: {
            title: 'Valor (R$)',
            tickformat: ',.2f',
            color: 'var(--text-color)'
        },
        margin: { t: 50, b: 100, l: 80, r: 50 },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { 
            family: 'Inter, sans-serif',
            color: 'var(--text-color)'
        }
    };

    Plotly.newPlot('grafico-faturamento', [faturamentoDaily, faturamentoCumulative], layoutFaturamento, defaultConfig);

    // Gráfico Mensal
    if (faturamentoMensal.length > 0) {
        const traceMensal = {
            x: faturamentoMensal.map(item => item.mes),
            y: faturamentoMensal.map(item => item.valor),
            type: 'bar',
            marker: {
                color: faturamentoMensal.map((item, index) => {
                    if (index === 0) return 'var(--primary-color)';
                    const anterior = faturamentoMensal[index - 1].valor;
                    return item.valor >= anterior ? 'var(--success-color)' : 'var(--danger-color)';
                }),
                opacity: 0.8,
                line: {
                    color: 'var(--primary-color)',
                    width: 1
                }
            }
        };

        const layoutMensal = {
            xaxis: { 
                title: 'Mês',
                color: 'var(--text-color)'
            },
            yaxis: { 
                title: 'Faturamento (R$)',
                tickformat: ',.2f',
                color: 'var(--text-color)'
            },
            margin: { t: 20, b: 50, l: 80, r: 50 },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { 
                family: 'Inter, sans-serif',
                color: 'var(--text-color)'
            }
        };

        Plotly.newPlot('grafico-mensal', [traceMensal], layoutMensal, defaultConfig);
    }

    // Função para alternar visualização do faturamento
    window.toggleFaturamentoView = function(view) {
        const update = view === 'daily' ? 
            {'visible': [true, false]} : 
            {'visible': [false, true]};
        
        const newTitle = view === 'daily' ? 'Faturamento Diário' : 'Faturamento Acumulado';
        
        Plotly.restyle('grafico-faturamento', update);
        Plotly.relayout('grafico-faturamento', {'title.text': newTitle});
        
        // Atualizar botões
        document.querySelectorAll('[onclick*="toggleFaturamentoView"]').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
    };

    // Função para definir períodos rápidos
    window.setPeriodo = function(dias) {
        const hoje = new Date();
        const inicio = new Date(hoje.getTime() - (dias * 24 * 60 * 60 * 1000));
        
        document.getElementById('data_inicio').value = inicio.toISOString().split('T')[0];
        document.getElementById('data_fim').value = hoje.toISOString().split('T')[0];
    };

    // Animação de entrada escalonada
    const cards = document.querySelectorAll('.chart-container, .kpi-card, .insights-card');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
    });

    // Hover effect nos KPIs
    const kpiCards = document.querySelectorAll('.kpi-card');
    kpiCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-8px) scale(1.02)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
        });
    });
});
</script>
{% endblock %}