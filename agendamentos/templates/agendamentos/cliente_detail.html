{% extends 'base.html' %}

{% block title %}{{ cliente.nome }} - Detalhes do Cliente{% endblock %}

{% block extra_css %}


{% endblock %}

{% block content %}
<!-- Header do Cliente -->
<div class="client-header">
  <h1 class="client-title">
    <i class="fas fa-user"></i>
    Perfil do Cliente
  </h1>
  <p class="client-subtitle">
    Cliente desde {{ cliente.criado_em|date:"d/m/Y" }}
    <span class="text-primary">• {{ cliente.nome }}</span>
  </p>
  
  <!-- Ações no Header -->
  <div class="header-actions">
    <a href="{% url 'agendamentos:agendamento_create' %}?cliente={{ cliente.pk }}" class="btn btn-success">
      <i class="fas fa-calendar-plus"></i>Novo Agendamento
    </a>
    <a href="{% url 'agendamentos:cliente_update' cliente.pk %}" class="btn btn-warning">
      <i class="fas fa-edit"></i>Editar
    </a>
    <a href="{% url 'agendamentos:cliente_list' %}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left"></i>Voltar
    </a>
  </div>
</div>

<!-- Perfil Principal -->
<div class="profile-card">
  <div class="row align-items-center">
    <div class="col-md-8">
      <div class="d-flex align-items-center">
        <div class="avatar-xl d-flex align-items-center justify-content-center me-4">
          {{ cliente.nome|first|upper }}
        </div>
        <div>
          <h2 class="mb-1">{{ cliente.nome }}</h2>
          <p class="mb-2 opacity-75">{{ cliente.idade }} anos • {{ cliente.email }}</p>
          <div class="d-flex flex-wrap gap-2">
            <a href="tel:{{ cliente.telefone }}" class="contact-link phone">
              <i class="fas fa-phone"></i>{{ cliente.telefone }}
            </a>
            <a href="https://wa.me/55{{ cliente.telefone|cut:' '|cut:'('|cut:')'|cut:'-' }}" 
               target="_blank" class="contact-link whatsapp">
              <i class="fab fa-whatsapp"></i>WhatsApp
            </a>
            <a href="mailto:{{ cliente.email }}" class="contact-link email">
              <i class="fas fa-envelope"></i>Email
            </a>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4 text-md-end mt-3 mt-md-0">
      {% if cliente.ativo %}
        <span class="status-badge">
          <i class="fas fa-check-circle me-1"></i>Cliente Ativo
        </span>
      {% else %}
        <span class="status-badge" style="background: rgba(108, 117, 125, 0.2) !important;">
          <i class="fas fa-times-circle me-1"></i>Cliente Inativo
        </span>
      {% endif %}
    </div>
  </div>
</div>

<!-- Estatísticas Rápidas -->
<div class="row g-2 mb-2">
  <div class="col-md-3">
    <div class="card stat-card">
      <div class="card-body">
        <i class="fas fa-calendar-check text-primary"></i>
        <h4 class="text-primary">{{ total_agendamentos }}</h4>
        <small>Total de Agendamentos</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card stat-card">
      <div class="card-body">
        <i class="fas fa-check-circle text-success"></i>
        <h4 class="text-success">{{ agendamentos_concluidos }}</h4>
        <small>Agendamentos Concluídos</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card stat-card">
      <div class="card-body">
        <i class="fas fa-times-circle text-danger"></i>
        <h4 class="text-danger">{{ agendamentos_cancelados }}</h4>
        <small>Cancelados/Faltas</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card stat-card">
      <div class="card-body">
        <i class="fas fa-percentage text-info"></i>
        <h4 class="text-info">{{ taxa_comparecimento }}%</h4>
        <small>Taxa de Comparecimento</small>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Coluna Principal -->
  <div class="col-lg-8 mb-2">
    <!-- Informações Pessoais -->
    <div class="card client-card">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
          <i class="fas fa-id-card me-2"></i>Informações Pessoais
        </h5>
      </div>
      <div class="card-body">
        <div class="row g-4">
          <div class="col-md-6">
            <div class="info-group">
              <label class="info-label">Nome Completo</label>
              <div class="info-value">{{ cliente.nome }}</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-group">
              <label class="info-label">CPF</label>
              <div class="info-value">{{ cliente.cpf }}</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-group">
              <label class="info-label">Data de Nascimento</label>
              <div class="info-value">
                {{ cliente.data_nascimento|date:"d/m/Y" }}
                <small class="text-muted ms-2">({{ cliente.idade }} anos)</small>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-group">
              <label class="info-label">Status</label>
              <div class="info-value">
                {% if cliente.ativo %}
                  <span class="badge bg-success">Ativo</span>
                {% else %}
                  <span class="badge bg-secondary">Inativo</span>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Informações de Contato -->
    <div class="card client-card">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0">
          <i class="fas fa-address-book me-2"></i>Informações de Contato
        </h5>
      </div>
      <div class="card-body">
        <div class="row g-4">
          <div class="col-md-6">
            <div class="info-group">
              <label class="info-label">Email</label>
              <div class="info-value">
                <a href="mailto:{{ cliente.email }}">
                  <i class="fas fa-envelope me-2"></i>{{ cliente.email }}
                </a>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-group">
              <label class="info-label">Telefone</label>
              <div class="info-value">
                <a href="tel:{{ cliente.telefone }}" class="me-3">
                  <i class="fas fa-phone me-2"></i>{{ cliente.telefone }}
                </a>
                <a href="https://wa.me/55{{ cliente.telefone|cut:' '|cut:'('|cut:')'|cut:'-' }}" 
                   target="_blank" class="text-success">
                  <i class="fab fa-whatsapp me-1"></i>WhatsApp
                </a>
              </div>
            </div>
          </div>
          {% if cliente.endereco %}
          <div class="col-12">
            <div class="info-group">
              <label class="info-label">Endereço</label>
              <div class="info-value">
                <i class="fas fa-map-marker-alt me-2"></i>{{ cliente.endereco }}
              </div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Observações -->
    {% if cliente.observacoes %}
    <div class="card client-card">
      <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">
          <i class="fas fa-sticky-note me-2"></i>Observações
        </h5>
      </div>
      <div class="card-body">
        <div class="bg-light p-3 rounded">
          <p class="mb-0">{{ cliente.observacoes|linebreaks }}</p>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Histórico de Agendamentos -->
    <div class="card client-card">
      <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="fas fa-history me-2"></i>Histórico de Agendamentos
        </h5>
        <span class="badge bg-light text-dark">{{ agendamentos.count }} registro{{ agendamentos.count|pluralize }}</span>
      </div>
      <div class="card-body p-0">
        {% if agendamentos %}
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Horário</th>
                  <th>Serviço</th>
                  <th>Valor</th>
                  <th>Status</th>
                  <th class="text-center">Ações</th>
                </tr>
              </thead>
              <tbody>
                {% for agendamento in agendamentos %}
                <tr class="agendamento-row" data-status="{{ agendamento.status }}">
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="date-mini text-center me-3">
                        <div class="day">{{ agendamento.data_agendamento|date:"d" }}</div>
                        <div class="month">{{ agendamento.data_agendamento|date:"M" }}</div>
                      </div>
                      <div>
                        <strong>{{ agendamento.data_agendamento|date:"d/m/Y" }}</strong>
                        <br><small class="text-muted">{{ agendamento.data_agendamento|date:"l" }}</small>
                      </div>
                    </div>
                  </td>
                  <td>
                    <strong>{{ agendamento.hora_inicio }}</strong>
                    <br><small class="text-muted">{{ agendamento.hora_fim }}</small>
                  </td>
                  <td>
                    <strong>{{ agendamento.servico.nome }}</strong>
                    <br><small class="text-muted">{{ agendamento.servico.duracao_formatada }}</small>
                  </td>
                  <td>
                    <span class="text-success fw-bold">
                      R$ {{ agendamento.valor_cobrado|default:agendamento.servico.preco|floatformat:2 }}
                    </span>
                  </td>
                  <td>
                    <span class="badge {{ agendamento.status_badge_class }}">
                      {% if agendamento.status == 'agendado' %}
                        <i class="fas fa-clock me-1"></i>
                      {% elif agendamento.status == 'confirmado' %}
                        <i class="fas fa-check me-1"></i>
                      {% elif agendamento.status == 'em_andamento' %}
                        <i class="fas fa-play me-1"></i>
                      {% elif agendamento.status == 'concluido' %}
                        <i class="fas fa-check-circle me-1"></i>
                      {% elif agendamento.status == 'cancelado' %}
                        <i class="fas fa-times me-1"></i>
                      {% elif agendamento.status == 'nao_compareceu' %}
                        <i class="fas fa-user-times me-1"></i>
                      {% endif %}
                      {{ agendamento.get_status_display }}
                    </span>
                  </td>
                  <td class="text-center">
                    <div class="btn-group btn-group-sm">
                      <a href="{% url 'agendamentos:agendamento_detail' agendamento.pk %}" 
                         class="btn btn-outline-primary" 
                         title="Ver detalhes">
                        <i class="fas fa-eye"></i>
                      </a>
                      {% if agendamento.pode_editar %}
                      <a href="{% url 'agendamentos:agendamento_update' agendamento.pk %}" 
                         class="btn btn-outline-warning" 
                         title="Editar">
                        <i class="fas fa-edit"></i>
                      </a>
                      {% endif %}
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="empty-state">
            <i class="fas fa-calendar-times"></i>
            <h5>Nenhum agendamento encontrado</h5>
            <p>Este cliente ainda não possui agendamentos.</p>
            <a href="{% url 'agendamentos:agendamento_create' %}?cliente={{ cliente.pk }}" class="btn btn-primary">
              <i class="fas fa-calendar-plus me-2"></i>Criar Primeiro Agendamento
            </a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Coluna Lateral -->
  <div class="col-lg-4">
    <!-- Ações Rápidas -->
    <div class="card client-card">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0">
          <i class="fas fa-bolt me-2"></i>Ações Rápidas
        </h5>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a href="{% url 'agendamentos:agendamento_create' %}?cliente={{ cliente.pk }}" class="btn btn-primary action-btn">
            <i class="fas fa-calendar-plus"></i>Novo Agendamento
          </a>
          <a href="{% url 'agendamentos:cliente_update' cliente.pk %}" class="btn btn-outline-warning action-btn">
            <i class="fas fa-edit"></i>Editar Cliente
          </a>
          <a href="tel:{{ cliente.telefone }}" class="btn btn-outline-primary action-btn">
            <i class="fas fa-phone"></i>Ligar para Cliente
          </a>
          <a href="mailto:{{ cliente.email }}" class="btn btn-outline-info action-btn">
            <i class="fas fa-envelope"></i>Enviar Email
          </a>
          <a href="https://wa.me/55{{ cliente.telefone|cut:' '|cut:'('|cut:')'|cut:'-' }}" 
             target="_blank" class="btn btn-outline-success action-btn">
            <i class="fab fa-whatsapp"></i>WhatsApp
          </a>
          <hr>
          <button type="button" 
                  class="btn btn-outline-danger action-btn" 
                  data-bs-toggle="modal" 
                  data-bs-target="#deleteModal">
            <i class="fas fa-trash"></i>Excluir Cliente
          </button>
        </div>
      </div>
    </div>

    <!-- Resumo Financeiro -->
    {% if total_agendamentos > 0 %}
    <div class="card client-card">
      <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">
          <i class="fas fa-chart-line me-2"></i>Resumo Financeiro
        </h5>
      </div>
      <div class="card-body">
        <div class="financial-item">
          <div class="d-flex justify-content-between align-items-center">
            <span><i class="fas fa-dollar-sign text-success me-2"></i>Total Faturado</span>
            <span class="h6 text-success mb-0">R$ {{ total_faturado|floatformat:2 }}</span>
          </div>
        </div>
        <div class="financial-item">
          <div class="d-flex justify-content-between align-items-center">
            <span><i class="fas fa-calculator text-info me-2"></i>Ticket Médio</span>
            <span class="h6 text-info mb-0">R$ {{ ticket_medio|floatformat:2 }}</span>
          </div>
        </div>
        <div class="financial-item">
          <div class="d-flex justify-content-between align-items-center">
            <span><i class="fas fa-calendar-check text-primary me-2"></i>Última Visita</span>
            <span class="text-muted">{{ ultima_visita|date:"d/m/Y" }}</span>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Informações do Sistema -->
    <div class="card client-card">
      <div class="card-header bg-light">
        <h6 class="mb-0">
          <i class="fas fa-info-circle me-2"></i>Informações do Sistema
        </h6>
      </div>
      <div class="card-body">
        <div class="info-group">
          <div class="d-flex justify-content-between">
            <span><strong>Cliente desde:</strong></span>
            <span>{{ cliente.criado_em|date:"d/m/Y H:i" }}</span>
          </div>
        </div>
        <div class="info-group">
          <div class="d-flex justify-content-between">
            <span><strong>Última atualização:</strong></span>
            <span>{{ cliente.atualizado_em|date:"d/m/Y H:i" }}</span>
          </div>
        </div>
        <div class="info-group">
          <div class="d-flex justify-content-between">
            <span><strong>ID do cliente:</strong></span>
            <span>#{{ cliente.pk }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-exclamation-triangle text-warning me-2"></i>
          Confirmar Exclusão
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Tem certeza que deseja excluir o cliente <strong>{{ cliente.nome }}</strong>?</p>
        
        {% if total_agendamentos > 0 %}
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Atenção:</strong> Este cliente possui {{ total_agendamentos }} agendamento{{ total_agendamentos|pluralize }} associado{{ total_agendamentos|pluralize }}. 
          A exclusão pode afetar esses registros.
        </div>
        {% else %}
        <div class="alert alert-warning">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Atenção:</strong> Esta ação não pode ser desfeita.
        </div>
        {% endif %}
        
        <div class="cliente-preview p-3">
          <div class="d-flex align-items-center">
            <div class="avatar-md d-flex align-items-center justify-content-center me-3">
              {{ cliente.nome|first|upper }}
            </div>
            <div>
              <strong>{{ cliente.nome }}</strong>
              <br><small class="text-muted">{{ cliente.email }} • {{ cliente.telefone }}</small>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-2"></i>Cancelar
        </button>
        <a href="{% url 'agendamentos:cliente_delete' cliente.pk %}" class="btn btn-danger">
          <i class="fas fa-trash me-2"></i>Excluir Cliente
        </a>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Destacar linha ao passar o mouse
    const agendamentoRows = document.querySelectorAll('.agendamento-row');
    agendamentoRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = 'var(--light-color)';
        });
        
        row.addEventListener('mouseleave', function() {
            const status = this.getAttribute('data-status');
            if (status === 'concluido') {
                this.style.backgroundColor = 'rgba(40, 167, 69, 0.05)';
            } else if (status === 'cancelado') {
                this.style.backgroundColor = 'rgba(220, 53, 69, 0.05)';
            } else {
                this.style.backgroundColor = '';
            }
        });
    });
    
    // Animar cards de estatísticas
    const statCards = document.querySelectorAll('.stat-card');
    statCards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-8px) scale(1.02)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
        });
    });
    
    // Animar financial items
    const financialItems = document.querySelectorAll('.financial-item');
    financialItems.forEach(item => {
        item.addEventListener('click', function() {
            this.style.transform = 'scale(1.02)';
            setTimeout(() => {
                this.style.transform = 'scale(1)';
            }, 200);
        });
    });
    
    // Confirmar exclusão
    const deleteButton = document.querySelector('[data-bs-target="#deleteModal"]');
    if (deleteButton) {
        deleteButton.addEventListener('click', function() {
            console.log('Preparando exclusão do cliente: {{ cliente.nome }}');
        });
    }
    
    // Animação de entrada escalonada
    const cards = document.querySelectorAll('.client-card');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
    });
});
</script>
{% endblock %}