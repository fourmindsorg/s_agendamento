{% extends 'base.html' %}

{% block title %}{{ tutorial.titulo }} - Tutorial{% endblock %}

{% block extra_css %}
<style>
  /* Header personalizado */
  .tutorial-header {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
    position: relative;
  }
  
  .tutorial-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-color) !important;
    margin: 15px 0 10px 0;
    line-height: 1.3;
  }
  
  .tutorial-description {
    color: var(--text-muted-color) !important;
    font-size: 1.1rem;
    line-height: 1.5;
    margin-bottom: 20px;
  }
  
  /* Ações no Header */
  .header-actions {
    position: absolute;
    top: 0;
    right: 0;
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: flex-end;
  }
  
  @media (max-width: 768px) {
    .header-actions {
      position: relative;
      top: auto;
      right: auto;
      margin-top: 20px;
      align-items: flex-start;
      flex-direction: row;
      flex-wrap: wrap;
    }
    
    .tutorial-title {
      font-size: 1.5rem;
    }
  }

  /* Breadcrumb styling */
  .breadcrumb {
    background: var(--light-color);
    border-radius: 10px;
    padding: 12px 15px;
    margin-bottom: 20px;
  }

  .breadcrumb-item a {
    color: var(--primary-color) !important;
    text-decoration: none;
    font-weight: 500;
  }

  .breadcrumb-item a:hover {
    text-decoration: underline;
  }

  .breadcrumb-item.active {
    color: var(--text-muted-color) !important;
  }

  /* Badge styling */
  .tutorial-badges {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }

  .tutorial-badge {
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .tutorial-badge.level-basico {
    background: var(--success-color) !important;
    color: white !important;
  }

  .tutorial-badge.level-intermediario {
    background: var(--warning-color) !important;
    color: white !important;
  }

  .tutorial-badge.level-avancado {
    background: var(--danger-color) !important;
    color: white !important;
  }

  .tutorial-badge.time {
    background: var(--secondary-color) !important;
    color: white !important;
  }

  .tutorial-badge.category {
    background: var(--info-color) !important;
    color: white !important;
  }

  .tutorial-badge.completed {
    background: var(--success-color) !important;
    color: white !important;
  }

  /* Content card */
  .content-card {
    border-radius: 15px;
    border: none;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    overflow: hidden;
    margin-bottom: 25px;
  }

  .content-card .card-body {
    padding: 30px;
  }

  /* Tutorial content styling */
  .tutorial-content {
    line-height: 1.8;
    font-size: 1.05rem;
    color: var(--text-color) !important;
  }

  .tutorial-content h1,
  .tutorial-content h2,
  .tutorial-content h3,
  .tutorial-content h4,
  .tutorial-content h5,
  .tutorial-content h6 {
    color: var(--primary-color) !important;
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-weight: 600;
  }

  .tutorial-content h1 {
    font-size: 1.8rem;
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 10px;
  }

  .tutorial-content h2 {
    font-size: 1.5rem;
  }

  .tutorial-content h3 {
    font-size: 1.3rem;
  }

  .tutorial-content p {
    margin-bottom: 1.2rem;
    color: var(--text-color) !important;
  }

  .tutorial-content ul,
  .tutorial-content ol {
    margin-bottom: 1.5rem;
    padding-left: 25px;
  }

  .tutorial-content li {
    margin-bottom: 8px;
    color: var(--text-color) !important;
  }

  .tutorial-content img {
    max-width: 100%;
    height: auto;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    margin: 1.5rem 0;
    border: 1px solid var(--border-color);
  }

  .tutorial-content pre {
    background: var(--light-color) !important;
    color: var(--text-color) !important;
    padding: 20px;
    border-radius: 10px;
    border-left: 4px solid var(--primary-color);
    overflow-x: auto;
    font-size: 0.9rem;
    margin: 1.5rem 0;
  }

  .tutorial-content code {
    background: var(--light-color);
    color: var(--primary-color) !important;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.9em;
  }

  .tutorial-content blockquote {
    border-left: 4px solid var(--success-color);
    background: rgba(40, 167, 69, 0.1);
    padding: 20px;
    margin: 1.5rem 0;
    border-radius: 0 10px 10px 0;
    color: var(--text-color) !important;
  }

  .tutorial-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
    background: var(--surface-color);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  .tutorial-content th,
  .tutorial-content td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-color) !important;
  }

  .tutorial-content th {
    background: var(--light-color);
    font-weight: 600;
    color: var(--primary-color) !important;
  }

  /* Navigation cards */
  .nav-card {
    background: var(--light-color) !important;
    border: none;
    border-radius: 15px;
    overflow: hidden;
  }

  .nav-card .card-body {
    padding: 25px;
  }

  .nav-btn {
    border-radius: 10px;
    padding: 15px 20px;
    transition: all 0.3s ease;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 12px;
    height: 100%;
  }

  .nav-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    text-decoration: none;
  }

  .nav-btn-prev {
    background: transparent;
    border: 2px solid var(--primary-color);
    color: var(--primary-color) !important;
  }

  .nav-btn-prev:hover {
    background: var(--primary-color);
    color: white !important;
  }

  .nav-btn-next {
    background: var(--gradient-bg);
    border: none;
    color: white !important;
  }

  .nav-btn-next:hover {
    box-shadow: 0 5px 15px var(--shadow-color);
    color: white !important;
  }

  .nav-text {
    flex: 1;
  }

  .nav-text small {
    display: block;
    opacity: 0.8;
    font-size: 0.8rem;
    margin-bottom: 4px;
  }

  .nav-text strong {
    font-size: 0.95rem;
    line-height: 1.3;
  }

  /* Completion section */
  .completion-section {
    text-align: center;
    padding: 30px;
    background: var(--light-color);
    border-radius: 15px;
  }

  .completion-icon {
    font-size: 3rem;
    color: var(--warning-color);
    margin-bottom: 15px;
  }

  /* Sidebar cards */
  .sidebar-card {
    border-radius: 15px;
    border: none;
    box-shadow: 0 3px 15px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    overflow: hidden;
  }

  .sidebar-card .card-header {
    border: none;
    padding: 15px 20px;
    font-weight: 600;
  }

  .sidebar-card .card-body {
    padding: 20px;
  }

  /* Progress bar */
  .progress {
    height: 25px;
    border-radius: 15px;
    background: var(--border-color);
    overflow: hidden;
  }

  .progress-bar {
    background: var(--gradient-bg) !important;
    border-radius: 15px;
    transition: width 0.6s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.85rem;
  }

  /* Action buttons */
  .action-btn {
    padding: 12px 20px;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
  }

  .action-btn:hover {
    transform: translateY(-2px);
  }

  .btn-complete {
    background: var(--success-color);
    border: none;
    color: white !important;
  }

  .btn-complete:hover {
    background: var(--success-color);
    box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
    color: white !important;
  }

  .btn-completed {
    background: transparent;
    border: 2px solid var(--success-color);
    color: var(--success-color) !important;
  }

  /* Related tutorials */
  .related-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px 0;
    border-bottom: 1px solid var(--border-color);
    transition: all 0.3s ease;
  }

  .related-item:last-child {
    border-bottom: none;
  }

  .related-item:hover {
    background: var(--light-color);
    margin: 0 -15px;
    padding: 12px 15px;
    border-radius: 8px;
  }

  .related-badge {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 600;
    color: white;
    flex-shrink: 0;
  }

  .related-content {
    flex: 1;
  }

  .related-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-color) !important;
    text-decoration: none;
    line-height: 1.3;
    margin-bottom: 4px;
    display: block;
  }

  .related-title:hover {
    color: var(--primary-color) !important;
    text-decoration: none;
  }

  .related-meta {
    font-size: 0.8rem;
    color: var(--text-muted-color) !important;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .content-card .card-body {
      padding: 20px;
    }

    .sidebar-card .card-body {
      padding: 15px;
    }

    .nav-card .card-body {
      padding: 20px;
    }

    .tutorial-content {
      font-size: 1rem;
    }

    .tutorial-badges {
      justify-content: center;
    }

    .header-actions {
      width: 100%;
      justify-content: center;
    }

    .nav-btn {
      padding: 12px 15px;
    }

    .nav-text strong {
      font-size: 0.9rem;
    }
  }

  /* Animations */
  .content-card, .sidebar-card, .nav-card {
    animation: slideInUp 0.5s ease-out;
  }

  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Button loading state */
  .btn-loading {
    position: relative;
    pointer-events: none;
  }

  .btn-loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    margin: auto;
    border: 2px solid transparent;
    border-top-color: #ffffff;
    border-radius: 50%;
    animation: button-loading-spinner 1s ease infinite;
  }

  @keyframes button-loading-spinner {
    from {
      transform: rotate(0turn);
    }
    to {
      transform: rotate(1turn);
    }
  }
</style>
{% endblock %}

{% block content %}
<!-- Header do Tutorial -->
<div class="tutorial-header">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{% url 'info:home' %}">Central de Ajuda</a>
      </li>
      <li class="breadcrumb-item">
        <a href="{% url 'info:tutoriais' %}">Tutoriais</a>
      </li>
      <li class="breadcrumb-item">
        <a href="{% url 'info:tutoriais' %}?categoria={{ tutorial.categoria.id }}">
          {{ tutorial.categoria.nome }}
        </a>
      </li>
      <li class="breadcrumb-item active">{{ tutorial.titulo }}</li>
    </ol>
  </nav>
  
  <!-- Título e Descrição -->
  <h1 class="tutorial-title">{{ tutorial.titulo }}</h1>
  <p class="tutorial-description">{{ tutorial.descricao }}</p>
  
  <!-- Badges -->
  <div class="tutorial-badges">
    <span class="tutorial-badge level-{{ tutorial.tipo }}">
      {{ tutorial.get_tipo_display }}
    </span>
    <span class="tutorial-badge time">
      <i class="fas fa-clock"></i>{{ tutorial.tempo_estimado }} minutos
    </span>
    <span class="tutorial-badge category">
      <i class="fas fa-folder"></i>{{ tutorial.categoria.nome }}
    </span>
    {% if user.is_authenticated and progresso.concluido %}
    <span class="tutorial-badge completed">
      <i class="fas fa-check-circle"></i>Concluído
    </span>
    {% endif %}
  </div>
  
  <!-- Ações no Header -->
  <div class="header-actions">
    {% if user.is_authenticated %}
      {% if not progresso.concluido %}
        <button class="btn btn-complete action-btn" onclick="marcarConcluido({{ tutorial.id }})">
          <i class="fas fa-check"></i>Marcar como Concluído
        </button>
      {% else %}
        <button class="btn btn-completed action-btn" disabled>
          <i class="fas fa-check-circle"></i>Concluído em {{ progresso.data_conclusao|date:"d/m/Y" }}
        </button>
      {% endif %}
    {% endif %}
    
    <div class="btn-group">
      {% if tutorial_anterior %}
        <a href="{% url 'info:tutorial_detail' tutorial_anterior.pk %}" 
           class="btn btn-outline-primary" title="Tutorial Anterior">
          <i class="fas fa-arrow-left"></i>
        </a>
      {% endif %}
      
      <a href="{% url 'info:tutoriais' %}?categoria={{ tutorial.categoria.id }}" 
         class="btn btn-outline-secondary">
        <i class="fas fa-list me-2"></i>Lista
      </a>
      
      {% if proximo_tutorial %}
        <a href="{% url 'info:tutorial_detail' proximo_tutorial.pk %}" 
           class="btn btn-outline-primary" title="Próximo Tutorial">
          <i class="fas fa-arrow-right"></i>
        </a>
      {% endif %}
    </div>
  </div>
</div>

<!-- Conteúdo Principal -->
<div class="row">
  <!-- Conteúdo do Tutorial -->
  <div class="col-lg-8">
    <div class="card content-card">
      <div class="card-body">
        <div class="tutorial-content">
          {{ tutorial.conteudo|safe }}
        </div>
      </div>
    </div>
    
    <!-- Navegação Entre Tutoriais -->
    <div class="card nav-card">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            {% if tutorial_anterior %}
              <a href="{% url 'info:tutorial_detail' tutorial_anterior.pk %}" 
                 class="nav-btn nav-btn-prev">
                <i class="fas fa-arrow-left"></i>
                <div class="nav-text">
                  <small>Tutorial Anterior</small>
                  <strong>{{ tutorial_anterior.titulo|truncatechars:45 }}</strong>
                </div>
              </a>
            {% endif %}
          </div>
          
          <div class="col-md-6">
            {% if proximo_tutorial %}
              <a href="{% url 'info:tutorial_detail' proximo_tutorial.pk %}" 
                 class="nav-btn nav-btn-next">
                <div class="nav-text">
                  <small>Próximo Tutorial</small>
                  <strong>{{ proximo_tutorial.titulo|truncatechars:45 }}</strong>
                </div>
                <i class="fas fa-arrow-right"></i>
              </a>
            {% else %}
              <div class="completion-section">
                <i class="fas fa-trophy completion-icon"></i>
                <h6>Parabéns!</h6>
                <small class="text-muted">Você concluiu todos os tutoriais desta categoria</small>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Sidebar -->
  <div class="col-lg-4">
    <!-- Progresso da Categoria -->
    <div class="card sidebar-card">
      <div class="card-header bg-primary text-white">
        <h6 class="mb-0">
          <i class="fas fa-chart-pie me-2"></i>Progresso - {{ tutorial.categoria.nome }}
        </h6>
      </div>
      <div class="card-body">
        {% if user.is_authenticated %}
          {% with tutoriais_categoria=tutorial.categoria.tutorial_set.all %}
            {% with total_categoria=tutoriais_categoria|length %}
              {% with concluidos_categoria=3 %}
                <div class="progress mb-3">
                  <div class="progress-bar" role="progressbar" 
                       style="width: {% widthratio concluidos_categoria total_categoria 100 %}%" 
                       aria-valuenow="{% widthratio concluidos_categoria total_categoria 100 %}" 
                       aria-valuemin="0" aria-valuemax="100">
                    {% widthratio concluidos_categoria total_categoria 100 %}%
                  </div>
                </div>
                <small class="text-muted">
                  <i class="fas fa-check-circle text-success me-1"></i>
                  {{ concluidos_categoria }} de {{ total_categoria }} tutoriais concluídos
                </small>
              {% endwith %}
            {% endwith %}
          {% endwith %}
        {% else %}
          <div class="text-center py-3">
            <i class="fas fa-info-circle fa-2x text-muted mb-2"></i>
            <p class="text-muted mb-0">
              Faça login para acompanhar seu progresso nos tutoriais
            </p>
          </div>
        {% endif %}
      </div>
    </div>
    
    <!-- Ações Rápidas -->
    <div class="card sidebar-card">
      <div class="card-header bg-info text-white">
        <h6 class="mb-0">
          <i class="fas fa-bolt me-2"></i>Ações Rápidas
        </h6>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a href="{% url 'agendamentos:dashboard' %}" class="btn btn-outline-primary btn-sm">
            <i class="fas fa-tachometer-alt me-2"></i>Ir para Dashboard
          </a>
          <a href="{% url 'info:faq' %}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-question-circle me-2"></i>Perguntas Frequentes
          </a>
          <a href="{% url 'info:demonstracao' %}" class="btn btn-outline-warning btn-sm">
            <i class="fas fa-desktop me-2"></i>Ver Demonstração
          </a>
          <a href="{% url 'info:guia_completo' %}" class="btn btn-outline-success btn-sm">
            <i class="fas fa-book me-2"></i>Guia Completo
          </a>
        </div>
      </div>
    </div>
    
    <!-- Tutoriais Relacionados -->
    <div class="card sidebar-card">
      <div class="card-header bg-secondary text-white">
        <h6 class="mb-0">
          <i class="fas fa-link me-2"></i>Tutoriais Relacionados
        </h6>
      </div>
      <div class="card-body">
        {% for relacionado in tutorial.categoria.tutorial_set.all|slice:":4" %}
          {% if relacionado.id != tutorial.id %}
            <div class="related-item">
              <div class="related-badge bg-{% if relacionado.tipo == 'basico' %}success{% elif relacionado.tipo == 'intermediario' %}warning{% else %}danger{% endif %}">
                {{ relacionado.get_tipo_display|slice:":1" }}
              </div>
              <div class="related-content">
                <a href="{% url 'info:tutorial_detail' relacionado.pk %}" 
                   class="related-title">
                  {{ relacionado.titulo|truncatechars:50 }}
                </a>
                <div class="related-meta">
                  <i class="fas fa-clock me-1"></i>{{ relacionado.tempo_estimado }}min
                  {% if user.is_authenticated and relacionado.id in tutoriais_concluidos %}
                    <i class="fas fa-check-circle text-success ms-2"></i>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endif %}
        {% empty %}
          <p class="text-muted text-center mb-0">
            <i class="fas fa-info-circle me-1"></i>
            Nenhum tutorial relacionado encontrado
          </p>
        {% endfor %}
      </div>
    </div>

    <!-- Ajuda Adicional -->
    <div class="card sidebar-card">
      <div class="card-header bg-warning text-white">
        <h6 class="mb-0">
          <i class="fas fa-life-ring me-2"></i>Precisa de Ajuda?
        </h6>
      </div>
      <div class="card-body text-center">
        <p class="text-muted mb-3">
          Não conseguiu seguir algum passo? Explore nossa central de ajuda completa.
        </p>
        <div class="d-grid gap-2">
          <a href="{% url 'info:faq' %}" class="btn btn-outline-primary btn-sm">
            <i class="fas fa-question-circle me-2"></i>FAQ
          </a>
          <a href="{% url 'info:tutoriais' %}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-graduation-cap me-2"></i>Outros Tutoriais
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function marcarConcluido(tutorialId) {
    const button = event.target.closest('button');
    const originalContent = button.innerHTML;
    
    // Loading state
    button.classList.add('btn-loading');
    button.innerHTML = '<span class="loading-spinner"></span>Processando...';
    button.disabled = true;
    
    fetch(`/info/ajax/tutorial/${tutorialId}/concluir/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Sucesso - recarregar página
            setTimeout(() => {
                location.reload();
            }, 500);
        } else {
            // Erro
            button.classList.remove('btn-loading');
            button.innerHTML = originalContent;
            button.disabled = false;
            alert('Erro ao marcar tutorial como concluído. Tente novamente.');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        button.classList.remove('btn-loading');
        button.innerHTML = originalContent;
        button.disabled = false;
        alert('Erro de conexão. Verifique sua internet e tente novamente.');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Smooth scroll para links internos
    const internalLinks = document.querySelectorAll('a[href^="#"]');
    internalLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
    
    // Highlight de código
    const codeBlocks = document.querySelectorAll('pre code');
    codeBlocks.forEach(block => {
        block.style.background = 'var(--light-color)';
        block.style.color = 'var(--text-color)';
    });
    
    // Animação de entrada escalonada
    const cards = document.querySelectorAll('.content-card, .sidebar-card, .nav-card');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
    });
    
    // Progress bar animation
    const progressBar = document.querySelector('.progress-bar');
    if (progressBar) {
        const targetWidth = progressBar.style.width;
        progressBar.style.width = '0%';
        setTimeout(() => {
            progressBar.style.width = targetWidth;
        }, 500);
    }
    
    // Lazy loading para imagens
    const images = document.querySelectorAll('.tutorial-content img');
    if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.style.opacity = '0';
                    img.style.transition = 'opacity 0.3s ease';
                    setTimeout(() => {
                        img.style.opacity = '1';
                    }, 100);
                    observer.unobserve(img);
                }
            });
        });
        
        images.forEach(img => imageObserver.observe(img));
    }
    
    // Reading progress indicator
    let ticking = false;
    function updateReadingProgress() {
        const scrollTop = window.pageYOffset;
        const docHeight = document.body.scrollHeight - window.innerHeight;
        const scrollPercent = scrollTop / docHeight;
        
        // Você pode adicionar uma barra de progresso de leitura aqui
        if (!ticking) {
            requestAnimationFrame(() => {
                // Atualizar indicador de progresso
                ticking = false;
            });
            ticking = true;
        }
    }
    
    window.addEventListener('scroll', updateReadingProgress);
});
</script>
{% endblock %}